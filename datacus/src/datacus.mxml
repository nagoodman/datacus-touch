<?xml version="1.0" encoding="utf-8"?>
<s:WindowedApplication xmlns:fx="http://ns.adobe.com/mxml/2009" 
					   xmlns:s="library://ns.adobe.com/flex/spark" 
					   xmlns:mx="library://ns.adobe.com/flex/mx"
					   xmlns:components="components.*"
					   backgroundColor="#FFFFFF"
					   minWidth="1440"
					   minHeight="920"
					   creationComplete="init()">  
					<!--make it full screen, but for now...-->
	
	<fx:Script>
		<![CDATA[

			protected function Picker_clickHandler():void
			{
				const state:String = currentState;
				if ( state == 'Page1' ) {
					currentState='Page2';
					populatePicker();
				}
				if ( state == 'Page2' ) {
					currentState='Page1';
				}
			}
			import com.adobe.serialization.json.JSON;
			
			import flash.display.Stage;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.events.DragEvent;
			import mx.managers.DragManager;
			import mx.rpc.events.ResultEvent;
			
			import spark.components.List;
			import spark.layouts.supportClasses.DropLocation;
			
			import tuio.*;
			import tuio.TouchEvent;
			import tuio.TuioClient;
			import tuio.connectors.UDPConnector;
			import tuio.debug.TuioDebug;
			import tuio.gestures.DragGesture;
			import tuio.gestures.GestureManager;
			import tuio.mouse.MouseToTouchDispatcher;
			import tuio.windows7.*;
			
			public var tc:TuioClient;
			public var tm:TuioManager;
			//public var gm:GestureManager;
			private var winTouch:Windows7TouchToTuioDispatcher;
			private var mTouch:MouseToTouchDispatcher;
			private var tDbg:TuioDebug;
			protected var mainStage:Stage;
			
			protected function init():void {
				mainStage = this.systemManager.stage;
				//makes full screen, but need to make sizinf relative first
				//mainStage.displayState = StageDisplayState.FULL_SCREEN_INTERACTIVE;
				tc = new TuioClient(new UDPConnector());
				tm = TuioManager.init(mainStage, tc);
				//gm = GestureManager.init(stage,tc);
				//GestureManager.addGesture(new DragGesture());
				winTouch = new Windows7TouchToTuioDispatcher(mainStage);
				mTouch = new MouseToTouchDispatcher(mainStage);
				tDbg = TuioDebug.init(mainStage);
				tc.addListener(tDbg);
				//these event listeners need to be added to each object
				mainStage.addEventListener(tuio.TouchEvent.TOUCH_DOWN, handleDown);
				//stage.addEventListener(org.tuio.TouchEvent.TOUCH_MOVE, handleMove);
				mainStage.addEventListener(tuio.TouchEvent.TOUCH_UP, handleUp);	
				//stage.addEventListener(flash.events.TransformGestureEvent.GESTURE_PAN, handleDrag);
				createQuery();
				//Creates a blank query that will be used for processing data 

				
			}
			
			
			public function handleDrag(e:TransformGestureEvent):void {
				//trace("dragged");
			}
			
			public function handleDown(e:tuio.TouchEvent):void {
				trace("TOUCHDOWN!");
				trace(e.relatedObject.name);
			}
			
			public function handleUp(e:tuio.TouchEvent):void {
				//trace("TOUCHUP!");
				//trace(e.relatedObject);
			}
			
			public function handleMove(e:tuio.TouchEvent):void {
				//trace("moving");
			} 
			
			
			
			
			//This is a public function that allows when array on series panel is changed to update the query
			public function moveToColumns(event:ResultEvent):void
			{
				
				results.send();//sends service call to get new graph info 
			}
			
			//This is a public function that allows when array on categories panel is changed to update the query
			public function moveToRows(event:ResultEvent):void
			{
				
				results.send(); //sends service call to get new graph info 
			}
			
			public function getResults(event:ResultEvent):void
			{
				
			
			}
			
			[Bindable]
			public var dp:ArrayCollection;
			
			[Bindable]
			public var mp:ArrayCollection;
			
			//After Query is created this tells it to initiate loading the picker
			private function createQuery():void
			{
				initializeQuery.send()
			}
			
			public function populatePicker():void{
				callDimensions.send();
			}
			public function getDimensions(event:ResultEvent):void
			{
				var rawData:String=String(event.result);
				var arr:Array = (JSON.decode(rawData)as Array);
				dp = new ArrayCollection();
				mp = new ArrayCollection();
				for (var i:int =0; i < arr.length; i++){
					var obj:Object = new Object;
					if(arr[i].caption == 'Measures'){
						obj.label = arr[i].caption;
						obj.value = arr[i].uniqueName;
						mp.addItem(obj);
					}
					else{
						obj.label = arr[i].caption;
						obj.value = arr[i].uniqueName;
						dp.addItem(obj);
					}
				}
				picker.DimensionsDLContainer.dimensionsList.dataProvider = dp;
				trace(mp[0].value);
				callLevels.send();
			}
			
			public function getLevels(event:ResultEvent):void
			{
				var rawData:String=String(event.result);
				var arr:Array = (JSON.decode(rawData)as Array);
				dp = new ArrayCollection();
				for (var i:int =0; i < arr.length; i++){
					var obj:Object = new Object;
					obj.label = arr[i].caption;
					obj.value = arr[i].uniqueName;
					dp.addItem(obj);	
				}
				picker.LevelsDLContainer.levelsList.dataProvider = dp;
				
			}
			
			public function getMembers(event:ResultEvent):void
			{
				var rawData:String=String(event.result);
				var arr:Array = (JSON.decode(rawData)as Array);
				dp = new ArrayCollection();
				for (var i:int =0; i < arr.length; i++){
					var obj:Object = new Object;
					obj.label = arr[i].caption;
					obj.value = arr[i].uniqueName;
					dp.addItem(obj);	
				}
				
				
			}
			
			
		]]>
	</fx:Script>
	<s:states>
		<s:State name="Page1"/>
		<s:State name="Page2"/>
	</s:states>
	<fx:Declarations>
		<!-- request to server to create a blank query -->
		<s:HTTPService id="initializeQuery" resultFormat="text" 
			url="http://localhost:8080/saiku/rest/saiku/admin/query/chartdata" 
			method="POST" >
			<s:request>
				<connection>FoodMart%20Connection</connection>
				<cube>Store</cube>
				<catalog>FoodMart</catalog>
				<schema>FoodMart</schema>
			</s:request>
		</s:HTTPService>
		
		<s:HTTPService id="callDimensions" resultFormat="text"
			url="http://localhost:8080/saiku/json/saiku/admin/query/chartdata/axis/UNUSED/"
			result="getDimensions(event)" />
		<s:HTTPService id="callLevels" resultFormat="text"
			url="http://localhost:8080/saiku/json/saiku/admin/query/chartdata/axis/UNUSED/dimension/Store/hierarchy/Store/"
			result="getLevels(event)" />
		<s:HTTPService id="callMembers" resultFormat="text"
			url="http://localhost:8080/saiku/json/saiku/admin/query/chartdata/axis/UNUSED/dimension/Store/hierarchy/Store/"
			result="getMembers(event)"/>
		
		<!-- request to server to move a new item to the ROWS (categories) axis for graphing-->
		<s:HTTPService id="toRows" resultFormat="text"
			url="http://localhost:8080/saiku/rest/saiku/admin/query/chartdata/axis/ROWS/dimension/Store%20Type/hierarchy/%5BStore%20Type%5D/%5BStore%20Type%5D.%5BStore%20Type%5D"
			method="POST" result="moveToRows(event)">
			<s:request xmlns="">
				<position>0</position>
				<memberposition>-1</memberposition>
			</s:request>
		</s:HTTPService>
		
		<!-- request to server to move a new item to the Columns (Series) axis for graphing-->
		<s:HTTPService id="toColumns" resultFormat="text"
			url="http://localhost:8080/saiku/rest/saiku/admin/query/chartdata/axis/COLUMNS/dimension/Store/hierarchy/%5BStore%5D/%5BStore%5D.%5BStore%20Country%5D"
			method="POST" result="moveToColumns(event)">
			<s:request xmlns="">
				<position>0</position>
				<memberposition>-1</memberposition>
			</s:request>
		</s:HTTPService>
		
		<!-- request to server to get the new chart information back from the server for graphing values-->
		<s:HTTPService id="results" resultFormat="text"
			url="http://localhost:8080/saiku/json/saiku/admin/query/chartdata/result"
			method="GET" result="getResults(event)" />
	</fx:Declarations>
	<fx:DesignLayer id="background">
<!--		I bet there's a better way to do the background		 -->
		<s:Rect id="bg" 
				width="100%" height="100%" 
				x="0" y="0">
			<s:fill>
				<s:SolidColor color="#CFE8FF"/>
			</s:fill>
			<s:filters>
				<s:GlowFilter alpha="1.0" blurX="6.0" blurY="6.0" color="0x5380d0" inner="true" knockout="false" quality="2" strength="1"/>
			</s:filters>
		</s:Rect>
	</fx:DesignLayer>
	<fx:DesignLayer id="panels">
<!--		organized left to right then top to bottom		 -->
		<components:Home id="home"
			x="20" y="20"
		/>
		<components:Measures id="measures"
 			left="20" top="260"
		/>
		<components:StateStep id="stateStep"
			x="20" y="780"
		/>
		<components:Pager id="pager"
			x="180" y="20"
		/>
		<components:Series id="series"
			x="180" y="140"
		/>
		<components:Graph id="graph" 
			x="180" y="260"
		/>
		<components:Categories id="categories"
			x="180" y="780"
		/>
		<components:ServerStatus id="serverStatus"
			x="1280" y="20"
		/>
		<components:Sets id="sets"
			x="1280" y="140"
		/>
		<components:Picker id="picker"
			x="180" y="260"
			click="Picker_clickHandler()" 
			currentState.Page2="State2">
		</components:Picker>
		<components:Trash id="trash"
			x="1280" y="780"
		/>	
	</fx:DesignLayer>
	<s:transitions>
		<s:Transition autoReverse="true" fromState="Page1" toState="Page2">
			<s:Parallel>
				<s:Parallel target="{picker}">
					<s:SetAction property="currentState" value="State2"/>
				</s:Parallel>
			</s:Parallel>
		</s:Transition>
		<s:Transition autoReverse="true" fromState="Page2" toState="Page1">
			<s:Parallel>
				<s:Parallel target="{picker}">
					<s:SetAction property="currentState" value="State1"/>
				</s:Parallel>
			</s:Parallel>
		</s:Transition>
	</s:transitions>
</s:WindowedApplication>
